<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Assistant - CiviSure</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üö® CiviSure</h2>
            </div>
            <nav>
                <ul class="sidebar-menu">
                    <li><a href="dashboard.html">üìä Dashboard</a></li>
                    <li><a href="report-crime.html">üìù Report Crime</a></li>
                    <li><a href="sos.html">üÜò SOS Alert</a></li>
                    <li><a href="crime-map.html">üó∫Ô∏è Crime Map</a></li>
                    <li><a href="legal-chatbot.html" class="active">‚öñÔ∏è Legal Assistant</a></li>
                    <li><a href="#" id="logoutBtn">üö™ Logout</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <h1>Legal AI Assistant</h1>
                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
            </div>

            <div class="content-area">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Chat with Legal Assistant</h2>
                        <button class="btn btn-small btn-secondary" id="clearChat">Clear Chat</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="chat-container">
                            <div class="chat-messages" id="chatMessages">
                                <div class="chat-message">
                                    <div class="chat-message-content">
                                        <p style="margin: 0;">üëã Hello! I'm your legal assistant. I can help you with:</p>
                                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                            <li>Understanding your human rights</li>
                                            <li>Guidance on filing complaints and cases</li>
                                            <li>Explaining legal terminology</li>
                                            <li>Information about legal procedures</li>
                                        </ul>
                                        <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">Note: I provide general information, not legal advice. For specific legal matters, please consult a licensed attorney.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input">
                                <input type="text" id="userMessage" placeholder="Ask about legal rights, procedures, or filing cases..." autocomplete="off">
                                <button class="btn btn-primary" id="sendBtn">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Suggested Questions</h2>
                    </div>
                    <div class="card-body">
                        <div id="suggestions" style="display: grid; gap: 0.5rem;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script>
        (async () => {
            await auth.requireAuth();
        })();

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                auth.logout();
            }
        });

        let conversationHistory = [];

        async function loadSuggestions() {
            try {
                const response = await fetch('/api/chatbot/suggestions');
                const data = await response.json();

                if (data.success) {
                    const suggestionsDiv = document.getElementById('suggestions');
                    suggestionsDiv.innerHTML = '';

                    data.suggestions.forEach(suggestion => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline';
                        btn.style.cssText = 'text-align: left; width: 100%; border: 1px solid #e5e7eb; color: #374151;';
                        btn.textContent = suggestion;
                        btn.onclick = () => {
                            document.getElementById('userMessage').value = suggestion;
                            sendMessage();
                        };
                        suggestionsDiv.appendChild(btn);
                    });
                }
            } catch (error) {
                console.error('Load suggestions error:', error);
            }
        }

        function addMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user' : ''}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'chat-message-content';
            contentDiv.innerHTML = `<p style="margin: 0; white-space: pre-wrap;">${content}</p>`;

            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('userMessage');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, true);
            input.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            conversationHistory.push({ role: 'user', content: message });

            try {
                const response = await fetch('/api/chatbot/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationHistory: conversationHistory
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage(data.response, false);
                    conversationHistory.push({ role: 'assistant', content: data.response });
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', false);
                }
            } catch (error) {
                console.error('Send message error:', error);
                addMessage('Sorry, I could not process your request. Please try again.', false);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        document.getElementById('sendBtn').addEventListener('click', sendMessage);

        document.getElementById('userMessage').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('clearChat').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the chat history?')) {
                document.getElementById('chatMessages').innerHTML = `
                    <div class="chat-message">
                        <div class="chat-message-content">
                            <p style="margin: 0;">Chat cleared. How can I help you?</p>
                        </div>
                    </div>
                `;
                conversationHistory = [];
            }
        });

        loadSuggestions();
    </script>
</body>
</html>